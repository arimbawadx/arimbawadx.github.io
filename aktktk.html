<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kas - Tekak-Tekik</title>
    <link rel="manifest" id="manifestPlaceholder">
    <meta name="theme-color" content="#0d6efd">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.4/dist/css/adminlte.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            padding: 1rem;
        }

        .header-card {
            background: linear-gradient(90deg, #0d6efd22, #0dcaf022);
        }

        .table-img-thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 4px;
        }

        .nowrap {
            white-space: nowrap;
        }

        .hidden {
            display: none !important;
        }
    </style>
    <!-- PWA Manifest Inline -->
    <script>
        const manifestData = {
            "name": "Kas Tekak-Tekik",
            "short_name": "KasTekik",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0d6efd",
            "theme_color": "#0d6efd",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='192' height='192' rx='32' fill='%230d6efd'/><text x='50%' y='55%' font-size='110' font-family='Arial' fill='white' text-anchor='middle' dominant-baseline='middle'>T</text></svg>",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any"
                },
                {
                    "src": "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='512' height='512' rx='64' fill='%230d6efd'/><text x='50%' y='55%' font-size='260' font-family='Arial' fill='white' text-anchor='middle' dominant-baseline='middle'>T</text></svg>",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById("manifestPlaceholder").setAttribute("href", manifestURL);
    </script>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="container">
        <!-- FILTER & EXPORT -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">Tahun</span>
                    <input id="filterYear" type="number" class="form-control" value="2025" min="2000" max="2100">
                    <button id="btnFilter" class="btn btn-primary">Filter</button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button id="btnExportPDF" class="btn btn-outline-danger">PDF</button>
                    <button id="btnExportExcel" class="btn btn-outline-success">Excel</button>
                    <button id="btnBackup" class="btn btn-outline-secondary">Backup</button>
                    <label class="btn btn-outline-secondary mb-0">Restore <input id="restoreFile" type="file"
                            accept="application/json" hidden></label>
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <div class="card header-card mb-3 p-3 d-flex align-items-center">
            <div class="d-flex align-items-center w-100">
                <div id="logoPreview"
                    style="width:64px;height:64px;display:flex;align-items:center;justify-content:center;margin-right:12px">
                    <!-- default inline SVG logo -->
                    <!-- <img id="logoImg"
                        src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect rx='12' ry='12' width='64' height='64' fill='%230d6efd'/><text x='50%' y='55%' font-size='26' fill='white' font-family='Arial' text-anchor='middle' dominant-baseline='middle'>T</text></svg>"
                        style="width:64px;height:64px;object-fit:contain" /> -->
                    <img id="logoImg" src="logo.png" style="width:64px;height:64px;object-fit:contain" />
                </div>
                <div class="text-center">
                    <div class="mb-0">Laporan Arus Kas Ogoh-Ogoh</div>
                    <div>Tekak-Tekik</div>
                    <div id="reportYear" class="fw-bold"></div>
                </div>
                <!-- <div class="ms-auto">
                    <label class="btn btn-sm btn-outline-secondary mb-0">Ubah Logo <input id="logoFile" type="file"
                            accept="image/*" hidden></label>
                </div> -->
            </div>
        </div>

        <!-- TABEL -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="mb-3 text-end">
                    <button id="btnAdd" class="btn btn-primary">Tambah Transaksi</button>
                </div>
                <div class="table-responsive">
                    <table id="tblKas" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Kategori</th>
                                <th>Uraian</th>
                                <th class="text-end">Pemasukan</th>
                                <th class="text-end">Pengeluaran</th>
                                <th>Bukti</th>
                                <th class="nowrap">Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Total</th>
                                <th id="totalPemasukan" class="text-end"></th>
                                <th id="totalPengeluaran" class="text-end"></th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- MODAL FORM -->
        <div class="modal fade" id="modalForm" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Tambah Transaksi</h5><button class="btn-close"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formKas">
                            <input type="hidden" id="recordId">
                            <div class="row g-2">
                                <div class="col-md-4"><label class="form-label">Tanggal</label><input id="tanggal"
                                        type="date" class="form-control" required></div>
                                <div class="col-md-4"><label class="form-label">Kategori</label><select id="kategori"
                                        class="form-select">
                                        <option value="pemasukan">Pemasukan</option>
                                        <option value="pengeluaran">Pengeluaran</option>
                                    </select></div>
                                <div class="col-md-4"><label class="form-label">Uraian</label><input id="uraian"
                                        type="text" class="form-control" required></div>

                                <!-- Only one of these will be visible at a time -->
                                <div class="col-md-6" id="wrapPengeluaran"><label
                                        class="form-label">Pengeluaran</label><input id="pengeluaran" type="number"
                                        class="form-control" value="0"></div>
                                <div class="col-md-6" id="wrapPemasukan"><label
                                        class="form-label">Pemasukan</label><input id="pemasukan" type="number"
                                        class="form-control" value="0"></div>

                                <div class="col-12"><label class="form-label">Bukti</label><input id="bukti" type="file"
                                        multiple class="form-control" accept="image/*,application/pdf">
                                    <div id="buktiPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer"><button id="btnSave" class="btn btn-success">Simpan</button><button
                            class="btn btn-secondary" data-bs-dismiss="modal">Batal</button></div>
                </div>
            </div>
        </div>

        <!-- MODAL BUKTI -->
        <div class="modal fade" id="modalBukti" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Bukti</h5><button type="button" class="btn-close"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="buktiContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- LIBRARIES -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.4/dist/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

    <!-- SCRIPT -->
    <script>
        const STORAGE_KEY = 'kas_data_v1';
        let dbKas = [];
        let table = null;

        // IndexedDB for files
        let idb;
        function idbInit() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('kas_bukti_db', 1);
                req.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains('bukti')) db.createObjectStore('bukti', { keyPath: 'id' }); };
                req.onsuccess = e => { idb = e.target.result; resolve(); };
                req.onerror = e => reject(e);
            });
        }
        function idbPut(obj) { return new Promise((res, rej) => { const tx = idb.transaction('bukti', 'readwrite'); tx.objectStore('bukti').put(obj); tx.oncomplete = res; tx.onerror = rej; }); }
        function idbGet(id) { return new Promise((res, rej) => { const tx = idb.transaction('bukti', 'readonly'); const r = tx.objectStore('bukti').get(id); r.onsuccess = () => res(r.result); r.onerror = () => rej(); }); }
        function idbDelete(id) { return new Promise((res, rej) => { const tx = idb.transaction('bukti', 'readwrite'); tx.objectStore('bukti').delete(id); tx.oncomplete = res; tx.onerror = rej; }); }

        function uid() { return 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8); }
        function currencyFormat(n) { return Number(n || 0).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function loadDB() { dbKas = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
        function saveDB() { localStorage.setItem(STORAGE_KEY, JSON.stringify(dbKas)); }

        // format tanggal ke "13 November 2025"
        function formatTanggalIndo(tgl) {
            if (!tgl) return '';
            const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const d = new Date(tgl);
            return `${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
        }

        // render table rows into DataTable
        async function render() {
            const year = Number($('#filterYear').val());
            let rows = dbKas.filter(r => new Date(r.tanggal).getFullYear() === year)
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            // update totals
            $('#totalPengeluaran').text(currencyFormat(rows.reduce((s, r) => s + Number(r.pengeluaran || 0), 0)));
            $('#totalPemasukan').text(currencyFormat(rows.reduce((s, r) => s + Number(r.pemasukan || 0), 0)));

            // map untuk DataTable (format tanggal + satu kolom nominal tiap sisi)
            const dtRows = rows.map(r => ({
                id: r.id,
                tanggal: formatTanggalIndo(r.tanggal),
                kategori: r.kategori,
                uraian: r.uraian,
                pemasukan: Number(r.pemasukan || 0),
                pengeluaran: Number(r.pengeluaran || 0),
                bukti: r.bukti || []
            }));

            table.clear().rows.add(dtRows).draw();
        }

        async function openForm(id) {
            $('#formKas')[0].reset(); $('#buktiPreview').html(''); $('#recordId').val('');
            if (id) {
                const rec = dbKas.find(x => x.id === id);
                if (!rec) return alert('Record tidak ditemukan');
                $('#recordId').val(rec.id);
                $('#tanggal').val(rec.tanggal);
                $('#kategori').val(rec.kategori);
                $('#uraian').val(rec.uraian);
                $('#pengeluaran').val(rec.pengeluaran || 0);
                $('#pemasukan').val(rec.pemasukan || 0);
                if (rec.bukti && rec.bukti.length) {
                    for (const bid of rec.bukti) {
                        const fo = await idbGet(bid);
                        if (fo && fo.thumb) $('#buktiPreview').append(`<div class='card p-1' style='width:96px'><img src='${fo.thumb}' class='img-fluid'/><div class='small text-truncate'>${fo.name}</div></div>`);
                    }
                }
            } else { $('#tanggal').val(new Date().toISOString().slice(0, 10)); }
            toggleAmountFields();
            new bootstrap.Modal(document.getElementById('modalForm')).show();
        }

        function toggleAmountFields() {
            const k = $('#kategori').val();
            if (k === 'pemasukan') {
                $('#wrapPemasukan').show(); $('#wrapPengeluaran').hide();
            } else {
                $('#wrapPemasukan').hide(); $('#wrapPengeluaran').show();
            }
        }

        async function handleBuktiInput(e) {
            $('#buktiPreview').html('');
            const files = Array.from(e.target.files || []);
            for (const f of files) { const d = await fileToDataURL(f); $('#buktiPreview').append(`<div class='card p-1' style='width:96px'><img src='${d}' class='img-fluid'/><div class='small text-truncate'>${f.name}</div></div>`); }
        }
        function fileToDataURL(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

        // Save form: store files to IndexedDB and metadata to localStorage
        async function saveForm() {
            const id = $('#recordId').val() || uid();
            const existing = dbKas.find(x => x.id === id);
            let buktiList = existing ? existing.bukti.slice() : [];
            const fileInput = document.getElementById('bukti');
            const files = Array.from(fileInput.files || []);
            if (files.length) {
                buktiList = [];
                for (const f of files) {
                    const data = await fileToDataURL(f);
                    const bid = uid();
                    await idbPut({ id: bid, name: f.name, type: f.type, data: data, thumb: data });
                    buktiList.push(bid);
                }
            }

            // only set the relevant nominal depending on kategori
            const kategori = $('#kategori').val();
            const pemasukanVal = Number($('#pemasukan').val() || 0);
            const pengeluaranVal = Number($('#pengeluaran').val() || 0);
            const rec = {
                id,
                tanggal: $('#tanggal').val(),
                kategori: kategori,
                uraian: $('#uraian').val(),
                pengeluaran: kategori === 'pengeluaran' ? pengeluaranVal : 0,
                pemasukan: kategori === 'pemasukan' ? pemasukanVal : 0,
                bukti: buktiList
            };

            const idx = dbKas.findIndex(x => x.id === id);
            if (idx >= 0) dbKas[idx] = rec; else dbKas.push(rec);
            saveDB(); await render();
            bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide();
        }

        async function deleteRecord(id) { if (!confirm('Hapus record?')) return; const rec = dbKas.find(x => x.id === id); if (rec && rec.bukti) { for (const b of rec.bukti) await idbDelete(b); } dbKas = dbKas.filter(x => x.id !== id); saveDB(); render(); }

        async function showBukti(id) { const rec = dbKas.find(x => x.id === id); if (!rec) return alert('Tidak ada bukti'); const c = $('#buktiContainer'); c.html(''); for (const b of rec.bukti) { const fo = await idbGet(b); if (!fo) continue; if (fo.type && fo.type.startsWith('image')) c.append(`<div class='mb-3'><img src='${fo.data}' class='img-fluid'/><div>${fo.name}</div></div>`); else c.append(`<div class='mb-2'><a href='${fo.data}' download='${fo.name}'>${fo.name}</a></div>`); } new bootstrap.Modal(document.getElementById('modalBukti')).show(); }

        // EXPORT PDF (lengkap sesuai permintaan)
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;

            const year = Number($('#filterYear').val());

            // SORT by tanggal
            const rows = dbKas
                .filter(r => new Date(r.tanggal).getFullYear() === year)
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            // HEADER + LOGO
            doc.setFontSize(12);
            // attempt to use logo image from #logoImg (dataURL)
            try {
                const logo = document.getElementById('logoImg').src;
                const logoW = 100;
                const logoH = 40;
                doc.addImage(logo, 'PNG', (pageWidth - logoW) / 2, margin, logoW, logoH);
            } catch (e) { /* ignore */ }

            doc.setFontSize(14);
            doc.text('Laporan Arus Kas', pageWidth / 2, margin + 80, { align: 'center' });
            doc.setFontSize(14);
            doc.text(`Ogoh-Ogoh Tahun ${year}`, pageWidth / 2, margin + 100, { align: 'center' });
            // doc.text(`Tahun ${year}`, pageWidth / 2, margin + 118, { align: 'center' });

            // Prepare table body with formatted tanggal and pills info
            const tableBody = rows.map(r => ([
                formatTanggalIndo(r.tanggal),
                r.kategori === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran',
                r.uraian || '-',
                currencyFormat(r.pemasukan || 0),
                currencyFormat(r.pengeluaran || 0)
            ]));

            doc.autoTable({
                startY: margin + 140,
                head: [['Tanggal', 'Kategori', 'Uraian', 'Pemasukan', 'Pengeluaran']],
                body: tableBody,
                theme: 'grid',
                headStyles: { fillColor: [240, 240, 240], textColor: 20, halign: 'center' },
                bodyStyles: { fontSize: 10 },
                didParseCell: function (data) {
                    // color the Kategori cell as pills: green for pemasukan, red for pengeluaran
                    if (data.column.index === 1 && data.cell.raw) {
                        const jenis = data.cell.raw;
                        if (jenis.toLowerCase().includes('pemasukan')) {
                            data.cell.styles.fillColor = [220, 255, 220];
                        } else {
                            data.cell.styles.fillColor = [255, 230, 230];
                        }
                        data.cell.text = [jenis];
                        data.cell.styles.textColor = 20;
                        data.cell.styles.halign = 'center';
                    }

                    // format tanggal column alignment
                    if (data.column.index === 0) data.cell.styles.halign = 'left';
                    if (data.column.index === 3 || data.column.index === 4) data.cell.styles.halign = 'right';
                }
            });

            // Totals as footer table (ke rapi)
            const totalPemasukan = rows.reduce((a, r) => a + (parseFloat(r.pemasukan) || 0), 0);
            const totalPengeluaran = rows.reduce((a, r) => a + (parseFloat(r.pengeluaran) || 0), 0);
            const totalKas = totalPemasukan - totalPengeluaran;

            const footerStartY = doc.lastAutoTable.finalY + 12;
            doc.autoTable({
                startY: footerStartY,
                head: [['', '', 'Total Pemasukan', 'Total Pengeluaran', 'Total Kas']],
                body: [['', '', currencyFormat(totalPemasukan), currencyFormat(totalPengeluaran), currencyFormat(totalKas)]],
                theme: 'grid',
                headStyles: { fillColor: [245, 245, 245], textColor: 20, halign: 'center' },
                bodyStyles: { fillColor: [250, 250, 250], halign: 'right' },
            });

            // Lampiran bukti: tiap record dipisah per halaman otomatis
            if (rows.length) {
                for (const [idx, rec] of rows.entries()) {
                    if (!rec.bukti || rec.bukti.length === 0) continue;
                    doc.addPage();
                    doc.setFontSize(14);
                    doc.text('Lampiran Bukti Transaksi', margin, 40);
                    doc.setFontSize(11);
                    doc.text(`${formatTanggalIndo(rec.tanggal)} — ${rec.uraian || '-'} — ${rec.kategori}`, margin, 60);

                    // start y for images
                    let y = 80;

                    for (const bid of rec.bukti) {
                        const fileObj = await idbGet(bid);
                        if (!fileObj) continue;

                        if (fileObj.type && fileObj.type.startsWith('image')) {
                            const img = fileObj.data;
                            // determine natural size
                            const imgProps = doc.getImageProperties(img);
                            const maxW = pageWidth - margin * 2;
                            const maxH = doc.internal.pageSize.getHeight() - 120; // leave space
                            let ratio = Math.min(maxW / imgProps.width, maxH / imgProps.height, 1);
                            let w = imgProps.width * ratio;
                            let h = imgProps.height * ratio;

                            // if current y + h exceeds page, create new page
                            if (y + h > doc.internal.pageSize.getHeight() - 40) {
                                doc.addPage();
                                y = 40;
                            }

                            doc.addImage(img, 'JPEG', margin, y, w, h);
                            y += h + 12;
                        } else {
                            doc.text(`File: ${fileObj.name}`, margin, y);
                            y += 18;
                        }

                        // if next image won't fit, add page (images grouped per record but may overflow)
                        if (y > doc.internal.pageSize.getHeight() - 80) {
                            doc.addPage();
                            y = 40;
                        }
                    }
                }
            }

            doc.save(`laporan-kas-${year}.pdf`);
        }

        // EXPORT EXCEL
        function exportExcel() {
            const year = Number($('#filterYear').val());
            const rows = dbKas.filter(r => new Date(r.tanggal).getFullYear() === year).sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            const arr = [['Tanggal', 'Kategori', 'Uraian', 'Pengeluaran', 'Pemasukan', 'BuktiCount']];
            rows.forEach(r => arr.push([formatTanggalIndo(r.tanggal), r.kategori, r.uraian, Number(r.pengeluaran || 0), Number(r.pemasukan || 0), (r.bukti || []).length]));
            const ws = XLSX.utils.aoa_to_sheet(arr);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Laporan'); XLSX.writeFile(wb, 'laporan-kas-' + year + '.xlsx');
        }

        // BACKUP: include metadata + all files from IndexedDB (base64 in backup) then download JSON
        async function backupData() {
            const data = { meta: dbKas, files: [] };
            const fileIds = new Set();
            dbKas.forEach(r => (r.bukti || []).forEach(id => fileIds.add(id)));
            for (const id of fileIds) { const fo = await idbGet(id); if (fo) data.files.push({ id: fo.id, name: fo.name, type: fo.type, data: fo.data }); }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            saveAs(blob, 'backup-kas-' + (new Date().toISOString().slice(0, 10)) + '.json');
        }

        // RESTORE: read JSON, write files to IndexedDB, write metadata to localStorage
        async function restoreHandler(e) {
            const f = e.target.files[0]; if (!f) return;
            try {
                const text = await f.text(); const parsed = JSON.parse(text);
                if (!parsed || !Array.isArray(parsed.meta)) return alert('File backup tidak valid');
                // write files
                if (Array.isArray(parsed.files)) {
                    for (const fo of parsed.files) { await idbPut({ id: fo.id, name: fo.name, type: fo.type, data: fo.data, thumb: fo.data }); }
                }
                dbKas = parsed.meta;
                saveDB(); await render(); alert('Restore selesai');
            } catch (err) { console.error(err); alert('Gagal restore: file tidak valid'); }
        }

        function applyFilter() { $('#reportYear').text('Tahun ' + $('#filterYear').val()); render(); }

        // INIT
        async function init() {
            await idbInit(); loadDB();

            table = $('#tblKas').DataTable({
                data: [],
                columns: [
                    { data: 'tanggal' },
                    { data: 'kategori' },
                    { data: 'uraian' },
                    { data: 'pemasukan', className: 'text-end', render: d => currencyFormat(d) },
                    { data: 'pengeluaran', className: 'text-end', render: d => currencyFormat(d) },
                    { data: 'bukti', render: (d, t, r) => `<div class="text-center">${(r.bukti || []).length} file</div>` },
                    { data: null, orderable: false, render: (d, t, r) => `<button class="btn btn-info btn-sm btn-view" data-id="${r.id}">View</button> <button class="btn btn-warning btn-sm btn-edit" data-id="${r.id}">Edit</button> <button class="btn btn-danger btn-sm btn-del" data-id="${r.id}">Del</button>` }
                ]
            });

            // events
            $('#btnFilter').on('click', applyFilter);
            $('#btnAdd').on('click', () => openForm());
            $('#btnSave').on('click', saveForm);
            $('#bukti').on('change', handleBuktiInput);
            $('#btnExportPDF').on('click', exportPDF);
            $('#btnExportExcel').on('click', exportExcel);
            $('#btnBackup').on('click', backupData);
            $('#restoreFile').on('change', restoreHandler);
            $('#tblKas').on('click', '.btn-del', e => deleteRecord(e.currentTarget.dataset.id));
            $('#tblKas').on('click', '.btn-edit', e => openForm(e.currentTarget.dataset.id));
            $('#tblKas').on('click', '.btn-view', e => showBukti(e.currentTarget.dataset.id));

            $('#kategori').on('change', toggleAmountFields);
            $('#logoFile').on('change', async e => {
                const f = e.target.files[0]; if (!f) return;
                const d = await fileToDataURL(f);
                document.getElementById('logoImg').src = d;
            });

            $('#filterYear').val(new Date().getFullYear());
            toggleAmountFields();
            render();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script>
        // Generate service worker from inline script
        const swCode = `
self.addEventListener('install', e => {
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  clients.claim();
});
self.addEventListener('fetch', (event) => {
  event.respondWith(fetch(event.request).catch(() => new Response('Offline')));
});
`;

        const swBlob = new Blob([swCode], { type: "text/javascript" });
        const swURL = URL.createObjectURL(swBlob);

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register(swURL)
                .then(() => console.log("SW ready"))
                .catch(err => console.error(err));
        }
    </script>
</body>

</html>